import tkinter as tk
from tkinter import ttk
import cv2
from PIL import Image, ImageTk
import threading
import numpy as np

# 動画プレーヤークラス
class VideoPlayer:
    def __init__(self, master, video_path, indices):
        self.master = master
        self.indices = indices
        self.cap = cv2.VideoCapture(str(video_path))
        self.frame = ttk.Frame(master)
        self.frame.pack()
        self.label = ttk.Label(self.frame)
        self.label.pack()
        self.play_speed = 1
        self.is_playing = False
        self.is_reversed = False
        self.current_frame = 0
        self.current_time = 0

        # ボタンの作成
        ttk.Button(self.frame, text="再生", command=self.play_video).pack(side=tk.LEFT)
        ttk.Button(self.frame, text="停止", command=self.stop_video).pack(side=tk.LEFT)
        ttk.Button(self.frame, text="早送り", command=self.fast_forward).pack(side=tk.LEFT)
        ttk.Button(self.frame, text="スロー再生", command=lambda: self.set_speed(0.2)).pack(side=tk.LEFT)
        ttk.Button(self.frame, text="逆再生", command=self.reverse_play).pack(side=tk.LEFT)
        ttk.Button(self.frame, text="巻き戻し", command=self.rewind).pack(side=tk.LEFT)
        # フレームと秒数を表示するLabelを追加
        self.status_label = ttk.Label(self.frame, text="Frame: 0 Time: 0.0s")
        self.status_label.pack(side=tk.LEFT)

    def update_frame(self):
        if self.is_playing:
            self.current_frame = int(self.cap.get(cv2.CAP_PROP_POS_FRAMES))
            self.current_time = self.current_frame / self.cap.get(cv2.CAP_PROP_FPS)
            self.status_label.config(text=f"Frame: {self.current_frame} Time: {self.current_time:.2f}s")

            if not self.is_reversed:
                ret, frame = self.cap.read()                                
            else:                
                # 巻き戻すフレーム数を増やす
                frame_no = max(0, self.current_frame - 2)
                self.cap.set(cv2.CAP_PROP_POS_FRAMES, frame_no)                                
                ret, frame = self.cap.read()       
                print(int(self.cap.get(cv2.CAP_PROP_POS_FRAMES)))
            if ret:
                frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                img = Image.fromarray(frame)                
                imgtk = ImageTk.PhotoImage(image=img)
                self.label.update_idletasks() #これいれないと動かなかった
                self.label.imgtk = imgtk
                self.label.configure(image=imgtk)                

                delay = int(1000 / self.cap.get(cv2.CAP_PROP_FPS) / self.play_speed)
                self.master.after(delay, self.update_frame)                                            

    def play_video(self):
        self.play_speed = 1
        if not self.is_playing:
            self.is_playing = True            
            self.is_reversed = False
            threading.Thread(target=self.update_frame).start()

    def stop_video(self):
        self.is_playing = False

    def fast_forward(self):
        if self.indices.size > 0:
            indices = [indices for indices in self.indices if indices > self.current_time]            
            if len(indices) > 0:
                self.cap.set(cv2.CAP_PROP_POS_FRAMES, indices[0] * self.cap.get(cv2.CAP_PROP_FPS))

    def set_speed(self, speed):
        self.play_speed = speed
        if not self.is_playing:
            self.play_video()

    def reverse_play(self):
        self.is_reversed = True
        self.is_playing = True
        self.update_frame()
        

    def rewind(self):
        if self.indices.size > 0:
            indices = [indices for indices in self.indices if indices < self.current_time]                
            if len(indices) > 0:
                self.cap.set(cv2.CAP_PROP_POS_FRAMES, (indices[-1] - 0.5) * self.cap.get(cv2.CAP_PROP_FPS))        

# GUIの実行
def main():
    import pathlib
    path  = pathlib.Path('C:/Users/S2/Documents/デバイス作成/2023測定デバイス/swallowing')
    video_path = path / '30min_data' / "2024-02-05 18-56-16.mkv"
    root = tk.Tk()
    root.title("Video Player")
    start_time = 5.77
    indices = np.array([[3.588344671201814, 9.152222222222223, 17.943696145124715, 18.963061224489795, 30.08392290249433, 59.48609977324263, 63.918503401360546, 71.23768707482994, 71.85460317460317, 74.19390022675736, 75.33875283446712, 79.90963718820862, 83.12718820861679, 93.70986394557823, 95.25886621315193, 98.45453514739229, 101.87961451247166, 106.04689342403628, 113.02789115646259, 115.08267573696145, 116.74342403628118, 120.62049886621315, 129.2977551020408, 133.9398866213152, 136.09938775510204, 153.23276643990928, 154.9039909297052, 155.41657596371883, 166.90090702947845, 168.74108843537414, 171.78986394557822, 176.67145124716552, 176.98013605442176, 179.73591836734693, 180.5351700680272, 184.760589569161, 191.05809523809523, 192.8021088435374, 195.98716553287983, 196.97664399092972, 198.1581179138322, 200.11326530612246, 206.51074829931972, 208.0398866213152, 209.05163265306123, 210.94433106575963, 222.12249433106575, 225.81056689342404, 228.1591609977324, 229.28997732426305, 230.52358276643992, 234.54006802721088, 235.59274376417233, 239.31145124716554, 241.23680272108842, 254.34936507936507, 276.03886621315195, 278.9855782312925, 279.9271201814059, 288.6693424036281, 291.1554875283447, 298.268253968254, 302.5063492063492, 303.68925170068024, 309.78680272108846, 311.0356462585034, 312.05909297052153, 319.3236961451247, 325.57444444444445, 334.0047619047619, 335.0574603174603, 338.7742857142857, 340.91401360544216, 342.06020408163266, 346.09006802721086, 347.7802721088435, 349.7875963718821, 352.75650793650794, 357.6910884353741, 367.2767800453515, 369.4716553287982, 375.7919954648526, 400.2620634920635, 416.9480045351474, 424.95598639455784, 427.798231292517, 441.2178911564626, 455.2457596371882, 478.95074829931974, 480.5444217687075, 497.0899546485261, 505.9968253968254, 508.1049659863946, 530.9889795918367, 535.5144217687075, 560.6965759637188, 576.4999319727891, 590.0651473922902, 590.6523129251701, 591.5491836734694, 598.3749659863946, 619.2528117913832, 620.4226530612245, 629.7980725623582, 649.708866213152, 651.4924943310658, 651.9895918367347, 678.2724036281179, 679.536462585034, 690.4145804988663, 721.991768707483, 730.5777324263039, 744.3666893424037, 757.7437868480725, 759.6445804988662, 762.8789342403628, 764.5906802721089, 765.933514739229, 781.1167346938776, 784.4621768707483, 787.5374603174603, 788.0584126984127, 788.5712471655329, 802.1985941043084, 834.0737868480726, 835.5544897959184, 836.6193197278911, 864.0891836734694, 872.7327437641724, 874.5234013605442, 893.5643310657597, 896.6202947845806, 897.9704535147392, 915.2352154195012, 920.725328798186, 941.6583673469388, 962.4232199546485, 963.6479365079365, 969.0636734693877, 970.4833786848072, 973.3114512471656, 974.6308390022675, 975.0228117913832, 975.5489569160998, 977.119365079365, 979.1121541950114, 986.8579138321995, 989.4580725623583, 996.2831519274376, 1000.4569387755103, 1016.8892743764172, 1018.5215646258504, 1035.495283446712, 1041.2028117913833, 1043.7400680272108, 1047.0279138321996, 1047.8448526077098, 1053.4396825396825, 1058.6995691609977, 1062.9185260770976, 1064.444058956916, 1080.405850340136, 1086.3625850340136, 1088.2784807256237, 1095.5039002267574, 1099.6212925170069, 1102.18358276644, 1120.2584580498867, 1121.0723809523809, 1123.9043537414966, 1127.8487074829932, 1137.2930839002267, 1154.0850793650793, 1160.3478004535148, 1174.7740362811792, 1180.8722222222223, 1181.7826757369614, 1215.2896371882086, 1228.6220634920635, 1233.5486848072562, 1234.2937414965986, 1240.6634240362812, 1245.758866213152, 1249.6901587301588, 1250.2759863945578, 1251.297074829932, 1263.462380952381, 1267.5021315192744, 1269.81641723356, 1276.6607029478457, 1284.9764399092971, 1287.8855102040816, 1290.7268253968255, 1295.6021088435375, 1316.392857142857, 1318.2725170068027, 1341.2745351473923, 1345.6571201814058, 1348.7351473922902, 1366.549319727891, 1387.5946258503402, 1412.3001360544217, 1440.9190702947847, 1443.0330839002268, 1460.7943764172335, 1464.2526303854875, 1487.9614512471655, 1508.7512698412697, 1518.9587074829933, 1525.7902721088435, 1526.3696371882086, 1533.7802040816327, 1543.6036507936508, 1545.6315646258504, 1556.3261224489795, 1565.52410430839, 1578.8531065759637, 1586.4823129251702, 1601.7380272108844, 1613.1453968253968, 1614.1848979591837, 1615.1656689342403, 1641.8507936507935, 1665.9834013605441, 1688.5208616780046, 1689.9157369614513, 1690.3233560090703, 1700.8153061224489, 1708.0067800453514, 1708.8345124716552, 1718.659977324263, 1724.954693877551, 1738.2263038548754, 1830.1216326530612, 1832.7907709750566]]) 
    indices = np.array([764.5906802721089, 765.933514739229, 781.1167346938776, 784.4621768707483, 787.5374603174603, 788.0584126984127, 788.5712471655329, 802.1985941043084, 834.0737868480726, 835.5544897959184, 836.6193197278911, 864.0891836734694, 872.7327437641724, 874.5234013605442, 893.5643310657597, 896.6202947845806, 897.9704535147392, 915.2352154195012, 920.725328798186, 941.6583673469388, 962.4232199546485, 963.6479365079365, 969.0636734693877, 970.4833786848072, 973.3114512471656, 974.6308390022675, 975.0228117913832, 975.5489569160998, 977.119365079365, 979.1121541950114, 986.8579138321995, 989.4580725623583, 996.2831519274376, 1000.4569387755103, 1016.8892743764172, 1018.5215646258504, 1035.495283446712, 1041.2028117913833, 1043.7400680272108, 1047.0279138321996, 1047.8448526077098, 1053.4396825396825, 1058.6995691609977, 1062.9185260770976, 1064.444058956916, 1080.405850340136, 1086.3625850340136, 1088.2784807256237, 1095.5039002267574, 1099.6212925170069, 1102.18358276644, 1120.2584580498867, 1121.0723809523809, 1123.9043537414966, 1127.8487074829932, 1137.2930839002267, 1154.0850793650793, 1160.3478004535148, 1174.7740362811792, 1180.8722222222223, 1181.7826757369614, 1215.2896371882086, 1228.6220634920635, 1233.5486848072562, 1234.2937414965986, 1240.6634240362812, 1245.758866213152, 1249.6901587301588, 1250.2759863945578, 1251.297074829932, 1263.462380952381, 1267.5021315192744, 1269.81641723356, 1276.6607029478457, 1284.9764399092971, 1287.8855102040816, 1290.7268253968255, 1295.6021088435375, 1316.392857142857, 1318.2725170068027, 1341.2745351473923, 1345.6571201814058, 1348.7351473922902, 1366.549319727891, 1387.5946258503402, 1412.3001360544217, 1440.9190702947847, 1443.0330839002268, 1460.7943764172335, 1464.2526303854875, 1487.9614512471655, 1508.7512698412697, 1518.9587074829933, 1525.7902721088435, 1526.3696371882086, 1533.7802040816327, 1543.6036507936508, 1545.6315646258504, 1556.3261224489795, 1565.52410430839, 1578.8531065759637, 1586.4823129251702, 1601.7380272108844, 1613.1453968253968, 1614.1848979591837, 1615.1656689342403, 1641.8507936507935, 1665.9834013605441, 1688.5208616780046, 1689.9157369614513, 1690.3233560090703, 1700.8153061224489, 1708.0067800453514, 1708.8345124716552, 1718.659977324263, 1724.954693877551, 1738.2263038548754, 1830.1216326530612, 1832.7907709750566]) 
    indices = indices + start_time
    print(indices)
    player = VideoPlayer(root, video_path, indices)
    root.mainloop()

if __name__ == "__main__":
    main()
